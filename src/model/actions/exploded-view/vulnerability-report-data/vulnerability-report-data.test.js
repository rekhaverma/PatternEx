import thunk from 'redux-thunk';
import configureMockStore from 'redux-mock-store';
import moxios from 'moxios';

import { ptrxZeppelin } from 'lib/rest/index';

import evpActions from '../actions';
import { getVulnerabilityReportData } from './vulnerability-report-data.action';

/**
 * @status: WIP
 * @sign-off-by: Alex Andries
 */
const middlewares = [thunk];
const mockStore = configureMockStore(middlewares);

describe('vulnerability-report-data action', () => {
  beforeEach(() => moxios.install(ptrxZeppelin));
  afterEach(() => moxios.uninstall(ptrxZeppelin));

  it('should dispatch SET_VULNERABILITY_REPORT_DATA action when fetching vulnerability report data has been done', (done) => {
    moxios.withMock(() => {
      const expectedActions = [
        {
          'type': evpActions.FETCH_VULNERABILITY_REPORT_DATA,
        },
        {
          'type': evpActions.SET_VULNERABILITY_REPORT_DATA,
          'payload': [], // @todo: update the response data to receive valid data
        }];

      const store = mockStore({
        mockStore: [],
      });

      store.dispatch(getVulnerabilityReportData('172.18.16.236 8.8.8.8'));

      moxios.wait(() => {
        const request = moxios.requests.mostRecent();
        request.respondWith({
          status: 200,
          response: {
            body: [
              {
                id: '2DDJT1RB1',
                name: 'Tenable Report',
              }],
          },
        })
          .then(() => {
            moxios.wait(() => {
              const request = moxios.requests.mostRecent();
              request.respondWith({
                status: 200,
                response: {
                  body: {
                    paragraphs: [
                      {}, {},
                      {
                        results: {
                          code: 'SUCCESS',
                          msg: [{ 'type': 'TABLE', 'data': 'plugin\tplugin_name\tfamily\tseverity\tip_addr\tnetbios_name\tdns_name\n' }],
                        },
                      },
                    ],
                  },
                },
              })
                .then(() => {
                  expect(store.getActions()).toEqual(expectedActions);
                  done();
                });
            });
          });
      });

    });
  });
});